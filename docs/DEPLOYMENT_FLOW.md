# 部署流程图

## 1. Web 应用部署流程

```
开发者推送代码
    │
    ▼
GitHub Repository (main 分支)
    │
    ▼
Vercel 自动检测变更
    │
    ▼
┌─────────────────────────────────┐
│  构建阶段 (Build Phase)         │
├─────────────────────────────────┤
│ 1. 安装依赖 (npm install)       │
│ 2. 生成 Prisma Client           │
│ 3. Next.js 构建 (next build)    │
│ 4. 优化和压缩                   │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  部署阶段 (Deploy Phase)        │
├─────────────────────────────────┤
│ 1. 创建 Serverless Functions    │
│ 2. 上传静态资源到 CDN           │
│ 3. 配置环境变量                 │
│ 4. 运行数据库迁移 (可选)        │
└─────────────────────────────────┘
    │
    ▼
生产环境部署完成
    │
    ▼
https://top-care-fashion.vercel.app
```

## 2. 移动应用部署流程

```
开发者推送代码
    │
    ▼
GitHub Repository (main 分支)
    │
    ▼
触发 EAS Build
    │
    ▼
┌─────────────────────────────────┐
│  构建阶段 (Build Phase)         │
├─────────────────────────────────┤
│ 1. 安装依赖 (npm install)       │
│ 2. 配置 Expo 环境变量           │
│ 3. 编译 React Native 代码       │
│ 4. 构建原生应用 (iOS/Android)   │
│ 5. 签名和打包                   │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  测试阶段 (Test Phase)          │
├─────────────────────────────────┤
│ 1. 内部测试构建                 │
│ 2. 功能测试                     │
│ 3. 性能测试                     │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  提交阶段 (Submit Phase)        │
├─────────────────────────────────┤
│ 1. 提交到 App Store (iOS)       │
│ 2. 提交到 Play Store (Android)  │
│ 3. 等待审核                     │
└─────────────────────────────────┘
    │
    ▼
应用商店发布
    │
    ▼
用户下载和安装
```

## 3. 数据库迁移流程

```
开发者创建迁移
    │
    ▼
npx prisma migrate dev --name migration_name
    │
    ▼
┌─────────────────────────────────┐
│  迁移文件生成                   │
├─────────────────────────────────┤
│ prisma/migrations/              │
│   └── YYYYMMDDHHMMSS_name/      │
│       └── migration.sql         │
└─────────────────────────────────┘
    │
    ▼
本地数据库测试
    │
    ▼
提交到 Git
    │
    ▼
Vercel 部署时自动运行
    │
    ▼
npx prisma migrate deploy
    │
    ▼
┌─────────────────────────────────┐
│  生产数据库迁移                 │
├─────────────────────────────────┤
│ 1. 连接生产数据库 (DIRECT_URL)  │
│ 2. 执行迁移 SQL                 │
│ 3. 验证迁移结果                 │
│ 4. 更新迁移历史                 │
└─────────────────────────────────┘
    │
    ▼
迁移完成
```

## 4. AI 服务调用流程

```
用户上传图片
    │
    ▼
移动端/Web 端
    │
    ▼
POST /api/ai/classify
    │
    ▼
Vercel Serverless Function
    │
    ▼
┌─────────────────────────────────┐
│  AI 服务处理                    │
├─────────────────────────────────┤
│ 1. 图片 Base64 编码             │
│ 2. 调用 Google Vision API       │
│    └─ 获取标签和描述            │
│ 3. 动态加载类别配置             │
│ 4. 加权评分计算                 │
│ 5. 返回分类结果                 │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  错误处理                       │
├─────────────────────────────────┤
│ 如果 AI 服务失败:               │
│ └─ 降级到规则引擎               │
└─────────────────────────────────┘
    │
    ▼
返回分类结果给客户端
```

## 5. 图片上传流程

```
用户选择图片
    │
    ▼
客户端压缩图片
    │
    ▼
POST /api/listings/upload-image
    │
    ▼
Vercel Serverless Function
    │
    ▼
┌─────────────────────────────────┐
│  上传处理                       │
├─────────────────────────────────┤
│ 1. 验证图片格式和大小           │
│ 2. SafeSearch 检测              │
│ 3. 生成唯一文件键               │
│ 4. 上传到 Supabase Storage      │
│    └─ 主存储桶: listing-images  │
│    └─ 备用存储桶: (故障转移)    │
│ 5. 生成公共 URL                 │
└─────────────────────────────────┘
    │
    ▼
返回图片 URL
    │
    ▼
保存到数据库
```

## 6. 实时消息流程

```
用户发送消息
    │
    ▼
POST /api/messages/{conversationId}
    │
    ▼
Vercel Serverless Function
    │
    ▼
┌─────────────────────────────────┐
│  消息处理                       │
├─────────────────────────────────┤
│ 1. 验证用户权限                 │
│ 2. 创建消息记录                 │
│ 3. 更新对话 last_message_at     │
│ 4. 创建通知记录                 │
└─────────────────────────────────┘
    │
    ▼
保存到数据库
    │
    ▼
客户端轮询检查新消息
    │
    ▼
GET /api/conversations/check
    │
    ▼
返回新消息
    │
    ▼
显示本地通知
```

## 7. Feed 推荐流程

```
用户打开 Feed
    │
    ▼
GET /api/feed/home?mode=foryou
    │
    ▼
Vercel Serverless Function
    │
    ▼
┌─────────────────────────────────┐
│  推荐算法处理                   │
├─────────────────────────────────┤
│ 1. 检查缓存 (20秒 TTL)          │
│ 2. 调用 PostgreSQL 函数         │
│    └─ get_feed_v2()             │
│ 3. 获取候选商品                 │
│    └─ 热门商品 (trending)       │
│    └─ 品牌匹配 (brand)          │
│    └─ 标签匹配 (tag)            │
│ 4. 应用 Boost 权重              │
│ 5. 综合评分计算                 │
│ 6. 品牌去重衰减                 │
│ 7. 排序和分页                   │
└─────────────────────────────────┘
    │
    ▼
返回推荐商品列表
    │
    ▼
客户端渲染 Feed
```

## 8. Premium 订阅流程

```
用户选择订阅计划
    │
    ▼
POST /api/profile/premium
    │
    ▼
Vercel Serverless Function
    │
    ▼
┌─────────────────────────────────┐
│  订阅处理                       │
├─────────────────────────────────┤
│ 1. 验证用户身份                 │
│ 2. 计算订阅时间                 │
│    └─ 如果已有订阅，延长        │
│    └─ 否则，创建新订阅          │
│ 3. 创建 premium_subscriptions    │
│ 4. 触发器自动更新 users 表      │
│    └─ is_premium = true         │
│    └─ premium_until = ends_at   │
│ 5. 重置免费 boost 计数          │
└─────────────────────────────────┘
    │
    ▼
返回订阅成功
    │
    ▼
用户享受 Premium 权益
```

## 9. Boost 推广流程

```
卖家选择商品推广
    │
    ▼
POST /api/listings/boost
    │
    ▼
Vercel Serverless Function
    │
    ▼
┌─────────────────────────────────┐
│  Boost 处理                     │
├─────────────────────────────────┤
│ 1. 验证卖家权限                 │
│ 2. 检查 Premium 免费额度        │
│ 3. 分离免费和付费 boost         │
│ 4. 创建 listing_promotions      │
│    └─ status: ACTIVE            │
│    └─ boost_weight: 1.50        │
│    └─ ends_at: +3 days          │
│ 5. 更新用户免费额度计数         │
└─────────────────────────────────┘
    │
    ▼
数据库视图自动更新
    │
    ▼
listing_recommendations_with_boost
    │
    ▼
Feed 算法应用 Boost 权重
    │
    ▼
商品在 Feed 中排名提升
```

## 10. OTA 更新流程

```
开发者发布更新
    │
    ▼
eas update --branch production
    │
    ▼
┌─────────────────────────────────┐
│  更新处理                       │
├─────────────────────────────────┤
│ 1. 打包 JavaScript 代码         │
│ 2. 上传到 Expo 服务器           │
│ 3. 生成更新清单                 │
└─────────────────────────────────┘
    │
    ▼
用户打开应用
    │
    ▼
检查更新
    │
    ▼
下载更新
    │
    ▼
应用更新（无需重新安装）
```

---

## 部署检查清单

### Web 应用部署前
- [ ] 环境变量配置完成
- [ ] 数据库迁移测试通过
- [ ] API 端点测试通过
- [ ] 图片上传功能测试
- [ ] AI 服务集成测试
- [ ] 错误处理测试

### 移动应用部署前
- [ ] 应用配置检查 (app.json)
- [ ] 环境变量配置 (extra字段)
- [ ] 图标和启动画面配置
- [ ] 构建配置检查 (eas.json)
- [ ] 应用商店信息准备
- [ ] 测试构建验证

### 数据库迁移前
- [ ] 迁移文件测试
- [ ] 备份生产数据库
- [ ] 迁移脚本验证
- [ ] 回滚计划准备
- [ ] 性能影响评估

### 生产环境部署后
- [ ] 功能测试
- [ ] 性能监控
- [ ] 错误日志检查
- [ ] 用户反馈收集
- [ ] 监控告警配置


