# 搜索Feed算法集成说明

## 概述

实现了两套搜索系统，可以同时工作，不影响生产环境：

1. **传统搜索系统**（默认）：`/api/listings` - 使用 Prisma 简单搜索
2. **Feed算法搜索系统**（可选）：`/api/search` - 使用 feed 算法的个性化搜索

## 系统架构

### 1. 传统搜索系统 (`/api/listings`)

**端点**: `GET /api/listings?search=xxx`

**特点**:
- ✅ 默认行为，不影响现有功能
- ✅ 简单文本匹配（名称、描述、品牌）
- ✅ 支持排序（价格、名称、日期）
- ✅ 不支持标签搜索（Prisma限制）
- ✅ 无个性化推荐

**使用场景**: 生产环境默认使用

### 2. Feed算法搜索系统 (`/api/search`)

**端点**: `GET /api/search?q=xxx&useFeed=true`

**特点**:
- ✅ 需要显式启用（`useFeed=true`）
- ✅ 集成 feed 算法的个性化推荐
- ✅ 支持标签搜索
- ✅ 考虑用户偏好（品牌、风格）
- ✅ 考虑用户历史行为
- ✅ 考虑 boost 和 trending 分数
- ✅ 搜索相关性评分
- ✅ 优雅降级（失败时回退到传统搜索）

**使用场景**: 可选功能，用于测试和未来升级

## API 使用方式

### 传统搜索（默认）

```bash
# 使用现有端点，行为不变
GET /api/listings?search=nike&limit=20&page=1
```

### Feed算法搜索（可选）

```bash
# 启用feed算法搜索
GET /api/search?q=nike&useFeed=true&limit=20&page=1

# 不启用feed算法（使用传统搜索作为fallback）
GET /api/search?q=nike&useFeed=false
# 或
GET /api/search?q=nike  # 默认useFeed=false
```

## 数据库函数

### `get_search_feed()`

**参数**:
- `p_supabase_user_id`: 用户ID（可为NULL，支持匿名用户）
- `p_search_query`: 搜索关键词
- `p_limit`: 结果数量
- `p_offset`: 偏移量
- `p_seed`: 随机种子
- `p_gender`: 性别过滤（可选）
- `p_category_id`: 分类ID（可选）

**返回**: 包含feed算法评分的搜索结果

**特点**:
- 搜索相关性评分（0-1）
- 用户偏好匹配（品牌、风格）
- 用户历史行为匹配
- Boost和trending分数
- 品牌多样性（brand decay）
- 随机化（score buckets）

## 评分公式

### 搜索相关性 (30%)
- 名称完全匹配: 1.0
- 名称前缀匹配: 0.9
- 名称包含匹配: 0.7
- 品牌完全匹配: 0.9
- 品牌包含匹配: 0.6
- 标签完全匹配: 0.8
- 标签包含匹配: 0.5
- 描述匹配: 0.3

### Feed算法评分 (70%)
- Boost/Trending分数: 25%
- 用户偏好匹配: 20%
- 用户选择的品牌+标签: 20%
- 用户选择的多个标签: 18%
- 用户选择的单个匹配: 15%
- 行为品牌+标签: 12%
- 行为多个标签: 10%
- 行为单个匹配: 8%

## 安全性

### 向后兼容
- ✅ 默认使用传统搜索，不影响现有功能
- ✅ Feed算法搜索需要显式启用
- ✅ 失败时自动回退到传统搜索

### 错误处理
- ✅ 搜索feed函数失败时，自动使用传统搜索
- ✅ 记录错误日志，但不影响用户体验
- ✅ 匿名用户支持（无个性化推荐）

## 性能考虑

### 传统搜索
- 使用 Prisma ORM
- 简单的数据库查询
- 快速响应

### Feed算法搜索
- 使用 PostgreSQL 函数
- 复杂的评分计算
- 支持缓存（通过seed参数）
- 30秒超时保护

## 测试建议

### 1. 功能测试
```bash
# 测试传统搜索（确保不受影响）
GET /api/listings?search=nike

# 测试feed算法搜索
GET /api/search?q=nike&useFeed=true

# 测试匿名用户
GET /api/search?q=nike&useFeed=true  # 无认证token
```

### 2. 性能测试
- 比较两种搜索的响应时间
- 测试feed算法搜索的并发性能
- 测试大量搜索结果的分页性能

### 3. 用户体验测试
- 比较两种搜索的结果质量
- 测试个性化推荐的准确性
- 测试搜索相关性的准确性

## 迁移计划

### 阶段1: 测试阶段（当前）
- ✅ Feed算法搜索作为可选功能
- ✅ 默认使用传统搜索
- ✅ 收集用户反馈

### 阶段2: 灰度发布
- 部分用户启用feed算法搜索
- 监控性能和错误率
- 收集用户体验数据

### 阶段3: 全面启用
- 所有用户默认使用feed算法搜索
- 传统搜索作为fallback
- 监控生产环境性能

## 注意事项

1. **不影响生产环境**: Feed算法搜索默认关闭，需要显式启用
2. **优雅降级**: 如果feed算法搜索失败，自动使用传统搜索
3. **匿名用户支持**: Feed算法搜索支持匿名用户（无个性化推荐）
4. **性能监控**: 需要监控feed算法搜索的性能和错误率
5. **用户反馈**: 收集用户对两种搜索系统的反馈

## 未来优化

1. **缓存优化**: 实现搜索结果缓存
2. **索引优化**: 优化数据库索引以提升搜索性能
3. **算法优化**: 根据用户反馈调整评分权重
4. **A/B测试**: 对比两种搜索系统的效果
5. **实时推荐**: 实现实时个性化推荐

