# Feedæ€§åˆ«ç­›é€‰ä¿®å¤

**ä¿®å¤æ—¶é—´**: 2025-01-27  
**é—®é¢˜**: ç”¨æˆ·æ›´æ”¹æ€§åˆ«ä¿¡æ¯åï¼Œfeedå†…å®¹æ²¡æœ‰å˜åŒ–

## ğŸ” é—®é¢˜åˆ†æ

### åŸå› 
1. **Feed APIä»URLå‚æ•°è¯»å–gender**
   - APIä» `url.searchParams.get("gender")` è·å–gender
   - å‰ç«¯æ²¡æœ‰ä¼ é€’genderå‚æ•°
   - é»˜è®¤ä½¿ç”¨ `"unisex"`

2. **get_feed_v2å‡½æ•°ä¾èµ–ä¼ å…¥å‚æ•°**
   - å‡½æ•°ä½¿ç”¨ `p_gender` å‚æ•°è¿›è¡Œç­›é€‰
   - æ²¡æœ‰ä»æ•°æ®åº“è¯»å–ç”¨æˆ·çš„genderä¿¡æ¯
   - å³ä½¿ç”¨æˆ·æ›´æ–°äº†æ•°æ®åº“ä¸­çš„genderï¼Œå‡½æ•°ä»ä½¿ç”¨é»˜è®¤å€¼

3. **ç¼“å­˜é—®é¢˜**
   - ç¼“å­˜é”®ä¸åŒ…å«ç”¨æˆ·ID
   - ä¸åŒç”¨æˆ·å¯èƒ½å…±äº«ç›¸åŒçš„ç¼“å­˜
   - ç¼“å­˜æ—¶é—´20ç§’ï¼Œå¯èƒ½å¯¼è‡´æ›´æ–°å»¶è¿Ÿ

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹get_feed_v2å‡½æ•°
- âœ… ä»usersè¡¨è¯»å–genderå­—æ®µ
- âœ… å¦‚æœp_genderå‚æ•°ä¸ºnullæˆ–'unisex'ï¼Œä½¿ç”¨æ•°æ®åº“ä¸­çš„gender
- âœ… å¦‚æœp_genderå‚æ•°æœ‰å€¼ï¼Œä¼˜å…ˆä½¿ç”¨å‚æ•°å€¼ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰

### 2. æ›´æ–°Feed API
- âœ… ç§»é™¤URLå‚æ•°ä¸­çš„genderè¯»å–
- âœ… ä¼ é€’nullç»™get_feed_v2å‡½æ•°ï¼Œè®©å‡½æ•°ä»æ•°æ®åº“è¯»å–
- âœ… æ›´æ–°ç¼“å­˜é”®ï¼ŒåŸºäºç”¨æˆ·IDè€Œä¸æ˜¯genderå‚æ•°

### 3. åˆ›å»ºè¿ç§»æ–‡ä»¶
- âœ… åˆ›å»ºè¿ç§»ï¼š`20251110000001_fix_get_feed_v2_read_gender_from_db`
- âœ… è®°å½•ä¿®å¤å†å²

## ğŸ“ ä¿®å¤è¯¦æƒ…

### å‡½æ•°é€»è¾‘
```sql
-- ä»æ•°æ®åº“è¯»å–ç”¨æˆ·çš„gender
SELECT
    u.id,
    u.gender,  -- æ–°å¢ï¼šä»æ•°æ®åº“è¯»å–gender
    ...
INTO v_user_id, v_user_gender, ...
FROM public.users u
WHERE u.supabase_user_id = p_supabase_user_id;

-- ä½¿ç”¨æ•°æ®åº“ä¸­çš„genderï¼ˆå¦‚æœå‚æ•°ä¸ºnullæˆ–'unisex'ï¼‰
IF p_gender IS NOT NULL AND lower(trim(p_gender)) NOT IN ('unisex', '') THEN
    v_gender_norm := lower(trim(p_gender));
ELSIF v_user_gender IS NOT NULL THEN
    v_gender_norm := lower(v_user_gender);  -- ä½¿ç”¨æ•°æ®åº“ä¸­çš„gender
ELSE
    v_gender_norm := 'unisex';
END IF;
```

### APIæ›´æ”¹
```typescript
// ä¹‹å‰ï¼šä»URLå‚æ•°è¯»å–gender
const gender = url.searchParams.get("gender");
result = await fetchForYou(supabaseUserId, limit, offset, seedId, gender);

// ä¹‹åï¼šä¼ é€’nullï¼Œå‡½æ•°ä»æ•°æ®åº“è¯»å–
result = await fetchForYou(supabaseUserId, limit, offset, seedId, null);
```

### ç¼“å­˜é”®æ›´æ–°
```typescript
// ä¹‹å‰ï¼šåŸºäºgenderå‚æ•°
const cacheKey = `${effectiveMode}|p=${page}|l=${limit}|seed=${seedId}|g=${gender ?? ""}`;

// ä¹‹åï¼šåŸºäºç”¨æˆ·ID
const cacheKey = `${effectiveMode}|uid=${supabaseUserId ?? "anon"}|p=${page}|l=${limit}|seed=${seedId}`;
```

## ğŸ§ª éªŒè¯ç»“æœ

### æµ‹è¯•1ï¼šå‡½æ•°ä»æ•°æ®åº“è¯»å–gender
- âœ… ç”¨æˆ·gender=Menï¼Œå‡½æ•°è¿”å›çš„å•†å“éƒ½æ˜¯Menæˆ–Unisex
- âœ… æ²¡æœ‰Womençš„å•†å“å‡ºç°åœ¨ç»“æœä¸­
- âœ… å‡½æ•°æ­£ç¡®ä½¿ç”¨æ•°æ®åº“ä¸­çš„genderå€¼

### æµ‹è¯•2ï¼šAPIè°ƒç”¨
- âœ… APIä¼ é€’nullç»™å‡½æ•°
- âœ… å‡½æ•°è‡ªåŠ¨ä»æ•°æ®åº“è¯»å–gender
- âœ… ç¼“å­˜é”®åŸºäºç”¨æˆ·IDï¼Œä¸åŒç”¨æˆ·çš„feedåˆ†åˆ«ç¼“å­˜

## âš ï¸ æ³¨æ„äº‹é¡¹

### ç¼“å­˜å½±å“
- **ç¼“å­˜æ—¶é—´**: 20ç§’
- **å½±å“**: ç”¨æˆ·æ›´æ–°genderåï¼Œå¯èƒ½éœ€è¦ç­‰å¾…æœ€å¤š20ç§’æ‰èƒ½çœ‹åˆ°æ–°feed
- **è§£å†³æ–¹æ¡ˆ**: 
  - ç”¨æˆ·åˆ·æ–°feedæ—¶ä½¿ç”¨ `noStore=1` å‚æ•°æ¸…é™¤ç¼“å­˜
  - æˆ–è€…ç¼©çŸ­ç¼“å­˜æ—¶é—´

### å…¼å®¹æ€§
- âœ… ä¿ç•™äº†p_genderå‚æ•°ï¼Œä¿æŒå‘åå…¼å®¹
- âœ… å¦‚æœå‰ç«¯ä¼ é€’äº†genderå‚æ•°ï¼Œå‡½æ•°ä»ä¼šä½¿ç”¨å‚æ•°å€¼
- âœ… å¦‚æœå‚æ•°ä¸ºnullï¼Œå‡½æ•°ä»æ•°æ®åº“è¯»å–

## ğŸ“Š æ•ˆæœ

### ä¿®å¤å‰
- âŒ ç”¨æˆ·æ›´æ–°genderåï¼Œfeedå†…å®¹ä¸å˜
- âŒ å‰ç«¯éœ€è¦ä¼ é€’genderå‚æ•°
- âŒ å‡½æ•°ä½¿ç”¨é»˜è®¤å€¼"unisex"

### ä¿®å¤å
- âœ… ç”¨æˆ·æ›´æ–°genderåï¼Œfeedè‡ªåŠ¨åæ˜ å˜åŒ–
- âœ… å‰ç«¯æ— éœ€ä¼ é€’genderå‚æ•°
- âœ… å‡½æ•°ä»æ•°æ®åº“è¯»å–æœ€æ–°çš„genderå€¼
- âœ… ä¸åŒç”¨æˆ·çš„feedæ­£ç¡®åˆ†ç¦»

## ğŸ”„ åç»­å»ºè®®

1. **æ¸…é™¤ç¼“å­˜æœºåˆ¶**
   - ç”¨æˆ·æ›´æ–°genderåï¼Œè‡ªåŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
   - æˆ–è€…åœ¨ç”¨æˆ·åˆ·æ–°feedæ—¶å¼ºåˆ¶æ¸…é™¤ç¼“å­˜

2. **ç›‘æ§**
   - ç›‘æ§å‡½æ•°æ‰§è¡Œæ—¶é—´
   - ç¡®ä¿ä»æ•°æ®åº“è¯»å–genderä¸ä¼šå½±å“æ€§èƒ½

3. **æµ‹è¯•**
   - æµ‹è¯•ä¸åŒgenderå€¼çš„ç”¨æˆ·
   - æµ‹è¯•genderä¸ºnullçš„ç”¨æˆ·
   - æµ‹è¯•æ›´æ–°genderåçš„feedå˜åŒ–

